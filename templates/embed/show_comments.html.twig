{% for comment in comments %}
    {% if comment.parent is null %}
        <div class="commentDiv">
            <div class="mb-1">
                <img src="{{ comment.user.profilePicture }}" alt="" class="smallProfilePicture">
                <a href="{{ path('show_my_account', {accountAlias: comment.user.accountAlias}) }}">  {{ comment.user.fullname }}</a>
            </div>
            <div style="border-bottom: 1px solid rgba(184,184,184, 0.5)">{{ comment.text }}</div>
            <span class="replay font-weight-bold" data-id="{{ comment.id }}" data-user="{{ comment.user.fullname }}">Replay</span>
            {% if comment.comments|length > 0 %}
                <span data-flag="hide" class="show-replays" data-id="{{ comment.id }}" data-count="{{ comment.comments|length }}">Show replays</span>
                <div class="replays-container"></div>
                <a href="" class="show-more-replays d-none" data-offset="0" data-id="{{ comment.id }}">Show more replays</a>
            {% endif %}
        </div>
        <div class="replayArea d-none">
            <form class="commentForm" action="{{ path('leave_comment', {postId: post.id}) }}" method="post">
                <input type="text" name="commentId" class="d-none commentId">
                <textarea name="commentInputField" rows='1' class="commentInputField form-group" placeholder="Leave a comment..."></textarea>
            </form>
        </div>
    {% endif %}
{% endfor %}
<script>
    $('.replay').click(function (e) {
        e.preventDefault();
        $('.commentId').val($(this).data('id'));
        if ($(this).data('status') === 'replay') {
            $(this).parent().parent().next().removeClass('d-none').addClass('d-block').find('.commentInputField').empty().text('@'+$(this).data('user') + ' ');
        } else {
            $(this).parent().next().removeClass('d-none').addClass('d-block').find('.commentInputField').empty();
        }
    });
    $('.show-replays').click(function (e) {
        e.preventDefault();

        let thisElement = $(this),
            nextElement = $(this).next(),
            commentId = $(this).data('id'),
            offset = 0;

        if ($(this).data('flag') == 'hide') {
            $.ajax({
                url: "/post/comment/replays/"+commentId,
                type: "post",
                data: {
                    offset: offset
                },
                success: function(response)
                {
                    $(nextElement).append(response);
                    $(thisElement).next().next().removeClass('d-none').addClass('d-block');
                    $(nextElement).removeClass('d-none').addClass('d-block-inline');
                    $(thisElement).data('flag', 'show');
                },
                error: function()
                {
                    console.log('error');
                }
            });
        } else {
            $(this).data('flag', 'hide');
            $(thisElement).next().next().removeClass('d-block').addClass('d-none');
            $(nextElement).empty();
            $(nextElement).addClass('d-none');
        }
    });

    $('.show-more-replays').click(function (e) {
        e.preventDefault();
        let thisElement = $(this),
            commentsDiv = $(this).prev(),
            commentId = $(this).data('id'),
            offset = parseInt($(this).attr('data-offset')) + 5,
            divCount = $(thisElement).prev().children('.replayDiv').length;

        if (divCount >= offset) {
            $.ajax({
                url: "/post/comment/replays/"+commentId,
                type: "post",
                data: {
                    offset: offset
                },
                success: function(response)
                {
                    $(commentsDiv).append(response);
                    $(thisElement).attr('data-offset', offset );
                    let divCountNew = $(thisElement).prev().children('.replayDiv').length;
                    if (divCountNew % 5 != 0) {
                        $(thisElement).removeClass('d-block').addClass('d-none');
                    }
                },
                error: function()
                {
                    console.log('error');
                }
            });
        }
    });

    $('.commentInputField').keyup(function (e) {
        e.preventDefault();
        if (e.which == 13) {
            $(this).parent('.commentForm').submit();
        }
    });
</script>


